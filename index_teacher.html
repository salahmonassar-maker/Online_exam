<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ â€“ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</title>
<style>
body{
    font-family: Tahoma;
    direction: rtl;
    background:#1b2735;
    color:#fff;
    margin:0;
    padding:0;
}
.container{
    max-width:1000px;
    margin:auto;
    background:#2c3e50;
    border-radius:15px;
    padding:20px;
    margin-top:20px;
}
h1,h2,h3{color:#ffdd57;}
input,button{
    padding:10px;
    margin:6px 0;
    border-radius:8px;
    border:none;
    font-size:16px;
}
button{background:#f39c12;cursor:pointer;}
button:hover{background:#f1c40f;}
.question{
    background:#34495e;
    padding:10px;
    border-radius:8px;
    margin:10px 0;
}
ul{list-style:none; padding:0;}
li{background:#34495e; margin:5px 0; padding:8px; border-radius:5px;}
label{display:block; margin-top:10px;}

/* CSS Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */
@media print {
    button,input,select { display:none; }
    body { background:#fff; color:#000; }
    .container { background:#fff; width:100%; }
    .question { background:#eee; color:#000; }
}
</style>
</head>
<body>

<div class="container">
<h1>Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ â€“ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h1>

<h3>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆØ§Ù„Ù…ÙˆØ¶ÙˆØ¹</h3>
<input id="subjectInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©">
<input id="topicInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹">
<button onclick="loadExam()">ğŸ” ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>

<hr>

<div id="examArea" style="display:none;">
<h2 id="examTitle"></h2>
<p id="examInfo"></p>
<div id="questionsContainer"></div>
<button onclick="submitExam()">âœ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
</div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyAC4PNyd-nolBmhhbn_AIWS5e1FaN4DoMI",
  authDomain: "online-exam-3d750.firebaseapp.com",
  projectId: "online-exam-3d750",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ (offline)
db.enablePersistence().catch((err)=>console.log("Persistence error:", err.code));

let examData = null;
let answers = [];

// ==== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ====
async function loadExam(){
    let subject = subjectInput.value.trim();
    let topic = topicInput.value.trim();
    if(!subject||!topic){ alert("âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆØ§Ù„Ù…ÙˆØ¶ÙˆØ¹"); return; }

    try {
        const doc = await db.collection("exams").doc(subject+"_"+topic).get({source:'default'});
        if(doc.exists){
            examData = doc.data();
            localStorage.setItem("cachedExam", JSON.stringify(examData));
            startExam(examData);
        } else {
            alert("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù†Ø´ÙˆØ±");
        }
    } catch (err) {
        console.log("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø©...");
        let cached = localStorage.getItem("cachedExam");
        if(cached){
            examData = JSON.parse(cached);
            startExam(examData);
        } else {
            alert("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆÙ„Ø§ Ù†Ø³Ø®Ø© Ù…Ø­ÙÙˆØ¸Ø©");
        }
    }
}

// ==== Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ====
function startExam(data){
    document.getElementById("examArea").style.display="block";
    document.getElementById("examTitle").innerText = data.subject + " - " + data.topic;
    document.getElementById("examInfo").innerText = `Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${data.numQuestions}, Ø²Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${data.timeLimit} Ø¯Ù‚ÙŠÙ‚Ø©`;

    const container = document.getElementById("questionsContainer");
    container.innerHTML="";
    answers = new Array(data.questions.length).fill(null);

    data.questions.forEach((q,i)=>{
        let div = document.createElement("div");
        div.className="question";
        div.innerHTML = `<p>${i+1}. ${q.q}</p>
        <label><input type="radio" name="q${i}" value="0"> ${q.o[0]}</label>
        <label><input type="radio" name="q${i}" value="1"> ${q.o[1]}</label>
        <label><input type="radio" name="q${i}" value="2"> ${q.o[2]}</label>
        <label><input type="radio" name="q${i}" value="3"> ${q.o[3]}</label>`;
        container.appendChild(div);

        // Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨
        div.querySelectorAll('input[type=radio]').forEach(r=>{
            r.addEventListener("change", ()=>{
                answers[i] = +r.value;
            });
        });
    });
}

// ==== Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ====
async function submitExam(){
    if(!examData){ alert("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø± Ù„ØªØ­Ù…ÙŠÙ„Ù‡"); return; }
    const studentName = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ");
    if(!studentName) return;

    let score=0;
    examData.questions.forEach((q,i)=>{
        if(answers[i]===q.a) score++;
    });

    const result = {
        student: studentName,
        subject: examData.subject,
        topic: examData.topic,
        score: score,
        total: examData.questions.length,
        timestamp: new Date()
    };

    try {
        await db.collection("results").add(result);
        alert(`âœ”ï¸ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù†ØªÙŠØ¬ØªÙƒ! Ø§Ù„Ø¯Ø±Ø¬Ø©: ${score}/${examData.questions.length}`);
    } catch {
        localStorage.setItem("pendingResult", JSON.stringify(result));
        alert(`âœ”ï¸ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ø¤Ù‚ØªÙ‹Ø§ ÙˆØ³ÙŠØªÙ… Ø±ÙØ¹Ù‡Ø§ Ø¹Ù†Ø¯ ØªÙˆÙØ± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. Ø§Ù„Ø¯Ø±Ø¬Ø©: ${score}/${examData.questions.length}`);
    }
}

// Ø±ÙØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¤Ø¬Ù„Ø© Ø¹Ù†Ø¯ ØªÙˆÙØ± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
window.addEventListener("online", async ()=>{
    let pending = localStorage.getItem("pendingResult");
    if(pending){
        try {
            await db.collection("results").add(JSON.parse(pending));
            localStorage.removeItem("pendingResult");
            console.log("âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø¤Ø¬Ù„Ø©");
        } catch(e){
            console.log("ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø¤Ø¬Ù„Ø©", e);
        }
    }
});
</script>

</body>
</html>
