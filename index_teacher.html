<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¹Ù„Ù… â€“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</title>
<style>
body{font-family:Tahoma;direction:rtl;background:#1b2735;color:#fff;margin:0;padding:0;}
.container{max-width:1000px;margin:auto;background:#2c3e50;border-radius:15px;padding:20px;margin-top:20px;}
h1,h2,h3{color:#ffdd57;}
input,button,select{padding:8px;margin:6px 0;border-radius:8px;border:none;font-size:16px;width:50%;max-width:300px;}
button{background:#f39c12;cursor:pointer;}button:hover{background:#f1c40f;}
table{width:100%;border-collapse:collapse;}th,td{border:1px solid #fff;padding:8px;text-align:center;}
.question{background:#34495e;padding:10px;border-radius:8px;margin:10px 0;}
@media print{button,input,select{display:none;}body{background:#fff;color:#000;}.container{background:#fff;width:100%;}.question{background:#eee;color:#000;}td,th{background:#eee;color:#000;border:1px solid #000;}}
</style>
</head>
<body>

<div class="container">
<h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª â€“ Ø§Ù„Ù…Ø¹Ù„Ù…</h1>

<h3>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©</h3>
<select id="examSelect"><option value="">-- Ø§Ø®ØªØ± Ø§Ø®ØªØ¨Ø§Ø±Ø§Ù‹ --</option></select>
<button onclick="loadExamForTeacher()">ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
<button onclick="hideExam()" style="background:#c0392b;color:#fff">ğŸ™ˆ Ø¥Ø®ÙØ§Ø¡ Ù„Ù„Ø·Ù„Ø§Ø¨</button>
<button onclick="deleteExam()" style="background:#e74c3c;color:#fff">âŒ Ø­Ø°Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>

<hr>

<h3>Ù†Ø´Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯</h3>
<input id="subjectInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©">
<input id="topicInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹">
<label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: <input type="number" id="numQuestions" value="5"></label>
<label>Ø²Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (Ø¯Ù‚Ø§Ø¦Ù‚): <input type="number" id="timeLimit" value="10"></label>
<button onclick="publishExam()">ğŸ’¾ Ù†Ø´Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„Ø·Ù„Ø§Ø¨</button>

<hr>

<h3>Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</h3>
<input id="qText" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„"><br>
<input id="o0" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 1">
<input id="o1" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 2">
<input id="o2" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 3">
<input id="o3" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 4"><br>
<input id="correct" type="number" min="0" max="3" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© (0-3)">
<br>
<button onclick="addQuestion()">â• Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</button>
<button onclick="updateQuestion()">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„</button>

<hr>

<h3>Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h3>
<table id="questionsTable">
<tr><th>#</th><th>Ø§Ù„Ø³Ø¤Ø§Ù„</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
</table>

<br>
<button onclick="exportQuestions()">â¬‡ï¸ ØªØµØ¯ÙŠØ± Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</button>
<input type="file" id="importFile" onchange="importQuestions(event)">

<hr>

<h2>ÙƒØ´Ù Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
<table id="resultsTable">
<tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th></tr>
</table>
<button onclick="loadResults()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
<button onclick="archiveAndDeleteResults()" style="background:#8e44ad;color:#fff">ğŸ“¦ Ø£Ø±Ø´ÙØ© ÙˆÙ…Ø³Ø­ ÙƒØ´Ù Ø§Ù„Ø·Ù„Ø§Ø¨</button>
<button onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒØ´Ù</button>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyAC4PNyd-nolBmhhbn_AIWS5e1FaN4DoMI",
  authDomain: "online-exam-3d750.firebaseapp.com",
  projectId: "online-exam-3d750",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ===== Ù…ØªØºÙŠØ±Ø§Øª =====
let questions = [];
let editIndex = null;
let currentExamId = null;
const questionsTable=document.getElementById("questionsTable");
const resultsTable=document.getElementById("resultsTable");
const examSelect=document.getElementById("examSelect");

// ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© =====
function addQuestion(){questions.push({q:qText.value,o:[o0.value,o1.value,o2.value,o3.value],a:+correct.value});clearForm();renderQuestions();}
function updateQuestion(){if(editIndex===null)return;questions[editIndex]={q:qText.value,o:[o0.value,o1.value,o2.value,o3.value],a:+correct.value};editIndex=null;clearForm();renderQuestions();}
function renderQuestions(){questionsTable.innerHTML="<tr><th>#</th><th>Ø§Ù„Ø³Ø¤Ø§Ù„</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>";questions.forEach((q,i)=>{let r=questionsTable.insertRow();r.insertCell(0).innerText=i+1;r.insertCell(1).innerText=q.q;r.insertCell(2).innerHTML=`<button onclick="editQuestion(${i})">âœï¸</button><button onclick="deleteQuestion(${i})">âŒ</button>`;});}
function editQuestion(i){editIndex=i;qText.value=questions[i].q;[o0.value,o1.value,o2.value,o3.value]=questions[i].o;correct.value=questions[i].a;}
function deleteQuestion(i){if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ")){questions.splice(i,1);renderQuestions();}}
function clearForm(){qText.value=o0.value=o1.value=o2.value=o3.value=correct.value="";}

// ===== ØªØµØ¯ÙŠØ± ÙˆØ§Ø³ØªÙŠØ±Ø§Ø¯ =====
function exportQuestions(){if(questions.length===0){alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§");return;}let a=document.createElement("a");a.href=URL.createObjectURL(new Blob([JSON.stringify(questions)],{type:"application/json"}));a.download="questions.json";a.click();}
function importQuestions(e){let file=e.target.files[0];if(!file)return;let reader=new FileReader();reader.onload=()=>{try{questions=JSON.parse(reader.result);renderQuestions();alert("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!");}catch{alert("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­");}};reader.readAsText(file);}

// ===== ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª =====
async function loadExamList(){
    examSelect.innerHTML='<option value="">-- Ø§Ø®ØªØ± Ø§Ø®ØªØ¨Ø§Ø±Ø§Ù‹ --</option>';
    const snapshot = await db.collection("exams").orderBy("createdAt").get();
    snapshot.forEach(doc=>{
        const d = doc.data();
        let opt=document.createElement("option");
        opt.value=doc.id;
        opt.text=d.subject+" - "+d.topic;
        examSelect.appendChild(opt);
    });
}
loadExamList();

// ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„Ù…Ø¹Ù„Ù… =====
async function loadExamForTeacher(){
    const selected=examSelect.value;
    if(!selected){alert("Ø§Ø®ØªØ± Ø§Ø®ØªØ¨Ø§Ø±Ø§Ù‹");return;}
    currentExamId=selected;
    const doc = await db.collection("exams").doc(selected).get();
    if(doc.exists){
        const data=doc.data();
        questions=data.questions||[];
        numQuestions.value=data.numQuestions||questions.length;
        timeLimit.value=data.timeLimit||10;
        subjectInput.value=data.subject;
        topicInput.value=data.topic;
        renderQuestions();
    }
}

// ===== Ù†Ø´Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± =====
function publishExam(){
    const subject=subjectInput.value.trim();
    const topic=topicInput.value.trim();
    if(!subject||!topic){alert("âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆØ§Ù„Ù…ÙˆØ¶ÙˆØ¹");return;}
    if(questions.length===0){alert("âš ï¸ Ø£Ø¶Ù Ø£Ø³Ø¦Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ù†Ø´Ø±");return;}
    const docId = subject+"_"+topic;
    db.collection("exams").doc(docId).set({
        subject,topic,questions,numQuestions:+numQuestions.value||questions.length,timeLimit:+timeLimit.value||10,
        createdAt:firebase.firestore.FieldValue.serverTimestamp(),
        isPublished:true
    }).then(()=>{alert("âœ”ï¸ ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­!");loadExamList();}).catch(err=>alert("âŒ Ø®Ø·Ø£: "+err));
}

// ===== Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„Ø·Ù„Ø§Ø¨ =====
function hideExam(){
    if(!currentExamId){alert("Ø§Ø®ØªØ± Ø§Ø®ØªØ¨Ø§Ø±Ø§Ù‹");return;}
    db.collection("exams").doc(currentExamId).update({isPublished:false})
    .then(()=>{alert("âœ… ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ù† Ø§Ù„Ø·Ù„Ø§Ø¨");loadExamList();})
    .catch(err=>alert("âŒ Ø®Ø·Ø£: "+err));
}

// ===== Ø­Ø°Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± =====
function deleteExam(){
    if(!currentExamId){alert("Ø§Ø®ØªØ± Ø§Ø®ØªØ¨Ø§Ø±Ø§Ù‹");return;}
    if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")){
        db.collection("exams").doc(currentExamId).delete()
        .then(()=>{alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±");loadExamList();questionsTable.innerHTML="<tr><th>#</th><th>Ø§Ù„Ø³Ø¤Ø§Ù„</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>";})
        .catch(err=>alert("âŒ Ø®Ø·Ø£: "+err));
    }
}

// ===== ØªØ­Ù…ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨ =====
async function loadResults(){
    resultsTable.innerHTML="<tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th></tr>";
    if(!currentExamId){alert("Ø§Ø®ØªØ± Ø§Ø®ØªØ¨Ø§Ø±Ø§Ù‹");return;}
    const doc = await db.collection("exams").doc(currentExamId).get();
    if(!doc.exists)return;
    const data=doc.data();
    const snapshot = await db.collection("results").where("subject","==",data.subject).where("topic","==",data.topic).get();
    snapshot.forEach(d=>{
        const r=d.data();
        let row = resultsTable.insertRow();
        row.insertCell(0).innerText=r.student;
        row.insertCell(1).innerText=r.score+"/"+r.total;
    });
}

// ===== Ø£Ø±Ø´ÙØ© ÙˆÙ…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ =====
async function archiveAndDeleteResults(){
    if(!currentExamId){alert("Ø§Ø®ØªØ± Ø§Ø®ØªØ¨Ø§Ø±Ø§Ù‹");return;}
    const doc = await db.collection("exams").doc(currentExamId).get();
    if(!doc.exists)return;
    if(!confirm("âš ï¸ Ø³ÙŠØªÙ… Ø£Ø±Ø´ÙØ© Ø¬Ù…ÙŠØ¹ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø«Ù… Ù…Ø³Ø­Ù‡Ø§ØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;
    const snapshot = await db.collection("results").where("subject","==",doc.data().subject).where("topic","==",doc.data().topic).get();
    const batch=db.batch();
    const archiveBatch=db.batch();
    snapshot.forEach(d=>{
        archiveBatch.set(db.collection("archive_results").doc(d.id),{...d.data(),archivedAt:new Date()});
        batch.delete(d.ref);
    });
    await archiveBatch.commit();
    await batch.commit();
    resultsTable.innerHTML="<tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th></tr>";
    alert("âœ… ØªÙ… Ø£Ø±Ø´ÙØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆÙ…Ø³Ø­Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­");
}
</script>
</body>
</html>
