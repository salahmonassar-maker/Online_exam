<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ â€“ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</title>
<style>
body{font-family:Tahoma;direction:rtl;background:#1b2735;color:#fff;margin:0;padding:0;}
.container{max-width:1000px;margin:auto;background:#2c3e50;border-radius:15px;padding:20px;margin-top:20px;}
h1,h2,h3{color:#ffdd57;}
input,button,select{padding:8px;margin:6px 0;border-radius:8px;border:none;font-size:16px;width:50%;max-width:300px;}
button{background:#f39c12;cursor:pointer;}button:hover{background:#f1c40f;}
.question{background:#34495e;padding:10px;border-radius:8px;margin:10px 0;}
ul{list-style:none;padding:0;}li{background:#34495e;margin:5px 0;padding:8px;border-radius:5px;}
@media print{button,input,select{display:none;}body{background:#fff;color:#000;}.container{background:#fff;width:100%;}.question{background:#eee;color:#000;}}
</style>
</head>
<body>

<div class="container">
<h1>Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ â€“ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h1>

<h3>Ø§Ø®ØªØ± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
<select id="examSelect"><option value="">-- Ø§Ø®ØªØ± Ø§Ø®ØªØ¨Ø§Ø±Ø§Ù‹ --</option></select>
<br>
<input id="studentName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)">
<br>
<button onclick="loadExam()">ğŸ” ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>

<hr>

<div id="examArea" style="display:none;">
<h2 id="examTitle"></h2>
<p id="examInfo"></p>
<div id="questionsContainer"></div>
<button onclick="submitExam()">âœ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
</div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAC4PNyd-nolBmhhbn_AIWS5e1FaN4DoMI",
  authDomain: "online-exam-3d750.firebaseapp.com",
  projectId: "online-exam-3d750",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
db.enablePersistence().catch(err=>console.log("Persistence error:",err.code));

let examData=null;
let answers=[];

// ===== ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø© =====
async function loadExamList(){
    const examSelect=document.getElementById("examSelect");
    examSelect.innerHTML='<option value="">-- Ø§Ø®ØªØ± Ø§Ø®ØªØ¨Ø§Ø±Ø§Ù‹ --</option>';
    const snapshot=await db.collection("exams").where("isPublished","==",true).orderBy("createdAt").get();
    snapshot.forEach(doc=>{
        const d=doc.data();
        let opt=document.createElement("option");
        opt.value=doc.id;
        opt.text=d.subject+" - "+d.topic;
        examSelect.appendChild(opt);
    });
}
loadExamList();

// ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± =====
async function loadExam(){
    const student=document.getElementById("studentName").value.trim();
    const selected=document.getElementById("examSelect").value;
    if(!student){alert("âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹"); return;}
    if(!selected){alert("âš ï¸ Ø§Ø®ØªØ± Ø§Ø®ØªØ¨Ø§Ø±Ø§Ù‹"); return;}

    try {
        const doc=await db.collection("exams").doc(selected).get();
        if(doc.exists){
            examData=doc.data();
            localStorage.setItem("cachedExam",JSON.stringify(examData));
            startExam(examData);
        } else {
            alert("âŒ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
        }
    } catch (err) {
        console.log("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø©...");
        let cached=localStorage.getItem("cachedExam");
        if(cached){examData=JSON.parse(cached);startExam(examData);}
        else{alert("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆÙ„Ø§ Ù†Ø³Ø®Ø© Ù…Ø­ÙÙˆØ¸Ø©");}
    }
}

// ===== Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± =====
function startExam(data){
    document.getElementById("examArea").style.display="block";
    document.getElementById("examTitle").innerText=data.subject+" - "+data.topic;
    document.getElementById("examInfo").innerText=`Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${data.numQuestions}, Ø²Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${data.timeLimit} Ø¯Ù‚ÙŠÙ‚Ø©`;

    const container=document.getElementById("questionsContainer");
    container.innerHTML="";
    answers=new Array(data.questions.length).fill(null);

    data.questions.forEach((q,i)=>{
        let div=document.createElement("div");
        div.className="question";
        div.innerHTML=`<p>${i+1}. ${q.q}</p>
        <label><input type="radio" name="q${i}" value="0"> ${q.o[0]}</label>
        <label><input type="radio" name="q${i}" value="1"> ${q.o[1]}</label>
        <label><input type="radio" name="q${i}" value="2"> ${q.o[2]}</label>
        <label><input type="radio" name="q${i}" value="3"> ${q.o[3]}</label>`;
        container.appendChild(div);

        div.querySelectorAll('input[type=radio]').forEach(r=>{
            r.addEventListener("change",()=>{answers[i]=+r.value;});
        });
    });
}

// ===== Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ =====
async function submitExam(){
    if(!examData){alert("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø± Ù„ØªØ­Ù…ÙŠÙ„Ù‡"); return;}
    const student=document.getElementById("studentName").value.trim();
    if(!student){alert("âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹"); return;}

    let score=0;
    examData.questions.forEach((q,i)=>{if(answers[i]===q.a) score++;});

    const result={
        student,
        subject:examData.subject,
        topic:examData.topic,
        score,
        total:examData.questions.length,
        timestamp:new Date()
    };

    try {
        await db.collection("results").add(result);
        alert(`âœ”ï¸ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù†ØªÙŠØ¬ØªÙƒ! Ø§Ù„Ø¯Ø±Ø¬Ø©: ${score}/${examData.questions.length}`);
    } catch {
        localStorage.setItem("pendingResult",JSON.stringify(result));
        alert(`âœ”ï¸ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ø¤Ù‚ØªÙ‹Ø§ ÙˆØ³ÙŠØªÙ… Ø±ÙØ¹Ù‡Ø§ Ø¹Ù†Ø¯ ØªÙˆÙØ± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. Ø§Ù„Ø¯Ø±Ø¬Ø©: ${score}/${examData.questions.length}`);
    }
}

// ===== Ø±ÙØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¤Ø¬Ù„Ø© Ø¹Ù†Ø¯ ØªÙˆÙØ± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª =====
window.addEventListener("online",async()=>{
    let pending=localStorage.getItem("pendingResult");
    if(pending){
        try{
            await db.collection("results").add(JSON.parse(pending));
            localStorage.removeItem("pendingResult");
            console.log("âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø¤Ø¬Ù„Ø©");
        }catch(e){console.log("ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø¤Ø¬Ù„Ø©",e);}
    }
});
</script>

</body>
</html>
