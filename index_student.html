<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>نظام الطالب – الاختبار</title>
<style>
body{font-family:Tahoma; direction:rtl; background:#1b2735;color:#fff;margin:0;padding:0;}
.container{max-width:900px;margin:auto;background:#2c3e50;border-radius:15px;padding:20px;margin-top:20px;}
h1,h2,h3{color:#ffdd57;}
input,button,select{padding:10px;margin:6px 0;border-radius:8px;border:none;font-size:16px;}
button{background:#f39c12;cursor:pointer;}
button:hover{background:#f1c40f;}
.question{background:#34495e;padding:10px;border-radius:8px;margin:10px 0;}
.correct{color:#2ecc71;font-weight:bold;}
.wrong{color:#e74c3c;font-weight:bold;}
table{width:100%;border-collapse:collapse;}
th,td{border:1px solid #fff;padding:8px;text-align:center;}
@media print{button,input,select{display:none;}body{background:#fff;color:#000;}.container{background:#fff;width:100%;}.question{background:#eee;color:#000;}td,th{background:#eee;color:#000;border:1px solid #000;}}
</style>
</head>
<body>
<div class="container">
<h1>نظام الطالب – الاختبار</h1>

<h3>الاسم:</h3>
<input type="text" id="studentName" placeholder="أدخل اسمك">

<h3>اختر المادة والموضوع</h3>
<select id="subjectSelect"><option value="">اختر المادة</option></select>
<select id="topicSelect"><option value="">اختر الموضوع</option></select>
<button onclick="loadExam()">تحميل الاختبار</button>

<hr>

<h3 id="examTitle"></h3>
<div id="questionsContainer"></div>

<button onclick="submitExam()" style="background:#27ae60;color:#fff">إرسال الإجابات</button>
<button onclick="showAnswers()" style="background:#2980b9;color:#fff">عرض الإجابات</button>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
 apiKey: "AIzaSyAC4PNyd-nolBmhhbn_AIWS5e1FaN4DoMI",

  authDomain: "online-exam-3d750.firebaseapp.com",

  projectId: "online-exam-3d750",

  storageBucket: "online-exam-3d750.firebasestorage.app",

  messagingSenderId: "630696307824",

  appId: "1:630696307824:web:9ed45dc0ff4434e1b858b5",

  measurementId: "G-Q4WNK7QVMF"

};


firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const subjectSelect = document.getElementById("subjectSelect");
const topicSelect = document.getElementById("topicSelect");
const questionsContainer = document.getElementById("questionsContainer");
const studentNameInput = document.getElementById("studentName");
let currentQuestions = [];
let studentAnswers = [];
let examInfo = {};

async function loadSubjects() {
    const snapshot = await db.collection("topics").orderBy("createdAt").get();
    const subjects = new Set();
    snapshot.forEach(doc => subjects.add(doc.data().subject));
    subjects.forEach(sub => {
        let option = document.createElement("option");
        option.value = sub;
        option.textContent = sub;
        subjectSelect.appendChild(option);
    });
}

subjectSelect.addEventListener("change", async () => {
    topicSelect.innerHTML = '<option value="">اختر الموضوع</option>';
    const selectedSubject = subjectSelect.value;
    const snapshot = await db.collection("topics").where("subject","==",selectedSubject).get();
    snapshot.forEach(doc => {
        const data = doc.data();
        let option = document.createElement("option");
        option.value = data.topic;
        option.textContent = data.topic;
        topicSelect.appendChild(option);
    });
});

async function loadExam() {
    const subject = subjectSelect.value;
    const topic = topicSelect.value;
    const studentName = studentNameInput.value.trim();

    if (!studentName) { alert("أدخل اسمك أولاً"); return; }
    if (!subject || !topic) { alert("اختر المادة والموضوع"); return; }

    const docRef = db.collection("exams").doc(subject + "_" + topic);
    const docSnap = await docRef.get();

    if (!docSnap.exists) { alert("لم يتم نشر الاختبار بعد"); return; }

    const data = docSnap.data();
    examInfo = {subject, topic, studentName};
    currentQuestions = data.questions.slice(0, data.numQuestions);
    studentAnswers = Array(currentQuestions.length).fill(null);

    displayQuestions(currentQuestions);
}

function displayQuestions(questions){
    questionsContainer.innerHTML = "";
    document.getElementById("examTitle").innerText = `اختبار: ${subjectSelect.value} - ${topicSelect.value}`;
    questions.forEach((q,i)=>{
        const div = document.createElement("div");
        div.className = "question";
        div.innerHTML = `<strong>سؤال ${i+1}:</strong> ${q.q}<br>
        ${q.o.map((opt,j)=>`<label><input type="radio" name="q${i}" value="${j}"> ${opt}</label><br>`).join('')}`;
        questionsContainer.appendChild(div);

        div.querySelectorAll('input[type=radio]').forEach(radio=>{
            radio.addEventListener('change',()=>{ studentAnswers[i]=parseInt(radio.value); });
        });
    });
}

async function submitExam(){
    const studentName = studentNameInput.value.trim();
    if(!studentName) { alert("أدخل اسمك"); return; }

    let score = 0;
    currentQuestions.forEach((q,i)=>{ if(studentAnswers[i]===q.a) score++; });

    await db.collection("results").add({
        student: studentName,
        subject: examInfo.subject,
        topic: examInfo.topic,
        answers: studentAnswers,
        score,
        total: currentQuestions.length,
        createdAt: new Date()
    });

    alert(`تم إرسال الإجابات! درجتك: ${score}/${currentQuestions.length}`);
}

function showAnswers(){
    currentQuestions.forEach((q,i)=>{
        const div = questionsContainer.children[i];
        let studentChoice = studentAnswers[i];
        div.innerHTML = `<strong>سؤال ${i+1}:</strong> ${q.q}<br>`;
        q.o.forEach((opt,j)=>{
            if(j === q.a){ div.innerHTML += `<p class="correct">✔️ ${opt}</p>`; }
            else if(j === studentChoice){ div.innerHTML += `<p class="wrong">❌ ${opt}</p>`; }
            else { div.innerHTML += `<p>${opt}</p>`; }
        });
    });
}

loadSubjects();
</script>
</body>
</html>
